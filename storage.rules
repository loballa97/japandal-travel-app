rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Helper function pour vérifier le rôle (custom claim ou Firestore)
    function isAdmin() {
      return request.auth.token.role == 'admin' 
        || request.auth.token.role == 'sub_admin';
    }
    
    function isManager() {
      return request.auth.token.role == 'manager';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Documents utilisateurs: documents/{role}/{userId}/{file}
    // Exemple: documents/clients/abc123/id_front.jpg
    //          documents/drivers/xyz789/registration.pdf
    match /documents/{role}/{userId}/{fileName} {
      // Lecture: propriétaire, managers et admins
      allow read: if request.auth != null && (
        isOwner(userId) || 
        isManager() || 
        isAdmin()
      );
      
      // Écriture: seulement le propriétaire
      allow write: if request.auth != null && isOwner(userId);
    }
    
    // Dossier public (optionnel pour assets partagés)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && isAdmin();
    }
    
    // Default deny pour tout le reste
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
